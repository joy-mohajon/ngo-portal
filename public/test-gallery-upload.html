<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery Upload Test</title>
    <meta name="csrf-token" content="test-token">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-4">Gallery Upload Test</h1>

        <button id="add-photos-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Open Upload Modal</button>

        <!-- Add Photos Modal -->
        <div id="gallery-upload-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg relative border border-indigo-100">
                <button id="close-gallery-modal" class="absolute top-4 right-4 text-gray-400 hover:text-indigo-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h4 class="text-2xl font-bold mb-2 text-indigo-700 text-center">Upload Project Photos</h4>
                <p class="text-gray-500 mb-6 text-center">Drag & drop images here, or click to select. Max 2MB each. Larger images will be automatically resized. JPG, PNG, GIF, WEBP.</p>
                <form id="gallery-upload-form" action="/test-endpoint" method="POST" enctype="multipart/form-data" class="space-y-4" data-project-id="4">
                    <input type="hidden" name="_token" value="test-token">
                    <input type="hidden" name="project_id" value="4">
                    <label for="gallery-images-input" class="block cursor-pointer">
                        <div id="gallery-drop-area" class="flex flex-col items-center justify-center border-2 border-dashed border-indigo-300 rounded-xl p-6 bg-indigo-50 hover:bg-indigo-100 transition mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5m0 0l5 5m-5-5v12" />
                            </svg>
                            <span class="text-indigo-500 font-medium">Click or drag files to upload</span>
                        </div>
                        <input type="file" name="images[]" id="gallery-images-input" accept="image/*" multiple class="hidden">
                    </label>
                    <div id="gallery-preview" class="flex flex-wrap gap-3 mb-2 min-h-[48px] border border-dashed border-gray-300 p-2 rounded"></div>
                    
                    <!-- Error container -->
                    <div id="upload-error-container" class="hidden p-3 bg-red-50 text-red-700 rounded-md border border-red-200 text-sm"></div>
                    
                    <div id="gallery-upload-progress" class="w-full h-2 bg-indigo-100 rounded overflow-hidden mb-2 hidden">
                        <div class="h-full bg-indigo-500 transition-all" style="width:0%"></div>
                    </div>
                    <button type="submit" class="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white px-6 py-2 rounded-xl font-semibold w-full shadow-lg transition">Upload</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const addBtn = document.getElementById('add-photos-btn');
            const modal = document.getElementById('gallery-upload-modal');
            const closeModal = document.getElementById('close-gallery-modal');
            const form = document.getElementById('gallery-upload-form');
            const input = document.getElementById('gallery-images-input');
            const preview = document.getElementById('gallery-preview');
            const csrf = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Constants for image resizing
            const MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB limit for server restrictions

            // Modal open/close
            addBtn?.addEventListener('click', () => {
                console.log('Opening modal');
                modal.classList.remove('hidden');
            });
            
            closeModal?.addEventListener('click', () => {
                console.log('Closing modal');
                modal.classList.add('hidden');
                form.reset();
                preview.innerHTML = '';
                
                // Clear error messages
                const errorContainer = document.getElementById('upload-error-container');
                if (errorContainer) {
                    errorContainer.innerHTML = '';
                    errorContainer.classList.add('hidden');
                }
            });

            // Image preview with resizing information
            input?.addEventListener('change', function () {
                console.log('File input changed:', this.files.length, 'files selected');
                preview.innerHTML = '';
                
                if (this.files.length === 0) return;
                
                Array.from(this.files).forEach((file, index) => {
                    console.log('Processing file:', file.name, file.type, file.size);
                    
                    if (!file.type.startsWith('image/')) {
                        console.log('Not an image file, skipping');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = e => {
                        console.log('File loaded:', file.name);
                        
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'relative p-2';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'w-16 h-16 object-cover rounded border';
                        img.setAttribute('data-original-size', formatFileSize(file.size));
                        
                        const sizeBadge = document.createElement('span');
                        sizeBadge.className = 'absolute -top-2 -right-2 bg-gray-800 text-white text-xs px-1 rounded-full';
                        sizeBadge.textContent = formatFileSize(file.size);
                        
                        const nameDisplay = document.createElement('div');
                        nameDisplay.className = 'text-xs mt-1 text-center truncate max-w-[64px]';
                        nameDisplay.textContent = file.name;
                        
                        imgContainer.appendChild(img);
                        imgContainer.appendChild(sizeBadge);
                        imgContainer.appendChild(nameDisplay);
                        preview.appendChild(imgContainer);
                        
                        // Show warning for large files
                        if (file.size > MAX_FILE_SIZE) {
                            sizeBadge.classList.remove('bg-gray-800');
                            sizeBadge.classList.add('bg-yellow-500');
                            
                            const warningText = document.createElement('div');
                            warningText.className = 'text-xs text-yellow-600 mt-1';
                            warningText.textContent = 'Will be resized';
                            imgContainer.appendChild(warningText);
                        }
                    };
                    
                    reader.onerror = () => {
                        console.error('Error reading file:', file.name);
                    };
                    
                    reader.readAsDataURL(file);
                });
            });

            // Drag-and-drop support
            const dropArea = document.getElementById('gallery-drop-area');
            dropArea?.addEventListener('dragover', e => { 
                e.preventDefault(); 
                dropArea.classList.add('ring-2', 'ring-indigo-400'); 
            });
            
            dropArea?.addEventListener('dragleave', e => { 
                dropArea.classList.remove('ring-2', 'ring-indigo-400'); 
            });
            
            dropArea?.addEventListener('drop', e => {
                e.preventDefault();
                dropArea.classList.remove('ring-2', 'ring-indigo-400');
                input.files = e.dataTransfer.files;
                console.log('Files dropped:', e.dataTransfer.files.length);
                input.dispatchEvent(new Event('change'));
            });

            // Helper function to format file size
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + 'B';
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + 'KB';
                return (bytes / 1048576).toFixed(1) + 'MB';
            }
            
            // Prevent form submission in this test
            form?.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted with', input.files.length, 'files');
                alert('Form submission prevented in this test');
            });
        });
    </script>
</body>
</html> 